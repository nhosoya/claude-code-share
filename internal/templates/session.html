{{define "title"}}Session {{.SessionID}}{{end}}
{{define "content"}}
<nav class="breadcrumb">
  <a href="/">Home</a> &gt; <a href="/projects/{{.Slug}}">{{.Path}}</a> &gt; Session
</nav>
<div class="page-header">{{.SessionID}}</div>
<div class="chat-container" id="chat">
  <div class="stats">
    <span class="stats-info">
      {{if .Conversation.Model}}{{.Conversation.Model}} &middot; {{end}}
      In: {{.Conversation.TotalInput}} tokens &middot;
      Out: {{.Conversation.TotalOutput}} tokens
    </span>
    <button class="toggle-btn" id="toggleTools" onclick="toggleTools()">Show tools</button>
    <button class="toggle-btn" id="screenshotBtn" onclick="copyScreenshot()">Copy screenshot</button>
  </div>
  {{range .Conversation.Entries}}
  {{if eq .Type "user"}}
    {{if .Message.Content.Text}}
    <div class="message-row user">
      <div class="avatar user-avatar"><svg viewBox="0 0 24 24" fill="#fff"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/></svg></div>
      <div class="bubble-wrap">
        <div class="bubble">
          <div class="message-content">{{.Message.Content.Text}}</div>
          <span class="timestamp">{{.Timestamp.Format "15:04"}}</span>
        </div>
      </div>
    </div>
    {{else if .Message.Content.Blocks}}
    <div class="message-row user tool-message">
      <div class="avatar user-avatar"><svg viewBox="0 0 24 24" fill="#fff"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/></svg></div>
      <div class="bubble-wrap">
        <div class="bubble">
          <details class="tool-use">
            <summary>Tool results ({{len .Message.Content.Blocks}} item{{if ne (len .Message.Content.Blocks) 1}}s{{end}})</summary>
            {{range .Message.Content.Blocks}}
              <div class="tool-result">[{{.Type}}] {{.ToolUseID}}</div>
            {{end}}
          </details>
          <span class="timestamp">{{.Timestamp.Format "15:04"}}</span>
        </div>
      </div>
    </div>
    {{end}}
  {{else if eq .Type "assistant"}}
    {{if hasText .Message.Content.Blocks}}
    <div class="message-row assistant">
      <div class="avatar assistant-avatar"><svg viewBox="0 0 24 24" fill="#fff"><path d="M12 2L9.2 9.2 2 12l7.2 2.8L12 22l2.8-7.2L22 12l-7.2-2.8z"/></svg></div>
      <div class="bubble-wrap">
        <div class="bubble">
          {{range .Message.Content.Blocks}}
            {{if eq .Type "text"}}
              <div class="message-content">{{.Text}}</div>
            {{else if eq .Type "tool_use"}}
              <details class="tool-use">
                <summary>{{.Name}}</summary>
                <pre>{{formatToolInput .Input}}</pre>
              </details>
            {{end}}
          {{end}}
          <span class="timestamp">{{.Timestamp.Format "15:04"}}</span>
        </div>
      </div>
    </div>
    {{else}}
    <div class="message-row assistant tool-message">
      <div class="avatar assistant-avatar"><svg viewBox="0 0 24 24" fill="#fff"><path d="M12 2L9.2 9.2 2 12l7.2 2.8L12 22l2.8-7.2L22 12l-7.2-2.8z"/></svg></div>
      <div class="bubble-wrap">
        <div class="bubble">
          {{range .Message.Content.Blocks}}
            {{if eq .Type "tool_use"}}
              <details class="tool-use">
                <summary>{{.Name}}</summary>
                <pre>{{formatToolInput .Input}}</pre>
              </details>
            {{end}}
          {{end}}
          <span class="timestamp">{{.Timestamp.Format "15:04"}}</span>
        </div>
      </div>
    </div>
    {{end}}
  {{end}}
  {{end}}
</div>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script>
function toggleTools() {
  var chat = document.getElementById('chat');
  var btn = document.getElementById('toggleTools');
  chat.classList.toggle('show-tools');
  var active = chat.classList.contains('show-tools');
  btn.textContent = active ? 'Hide tools' : 'Show tools';
  btn.classList.toggle('active', active);
}

function copyScreenshot() {
  var btn = document.getElementById('screenshotBtn');
  var chat = document.getElementById('chat');
  btn.textContent = 'Capturing...';
  btn.disabled = true;

  // Hide buttons during capture
  var stats = chat.querySelector('.stats');
  stats.style.display = 'none';

  html2canvas(chat, { backgroundColor: null, scale: 2 }).then(function(canvas) {
    stats.style.display = '';
    canvas.toBlob(function(blob) {
      navigator.clipboard.write([
        new ClipboardItem({ 'image/png': blob })
      ]).then(function() {
        btn.textContent = 'Copied!';
        setTimeout(function() {
          btn.textContent = 'Copy screenshot';
          btn.disabled = false;
        }, 2000);
      }).catch(function() {
        btn.textContent = 'Failed';
        setTimeout(function() {
          btn.textContent = 'Copy screenshot';
          btn.disabled = false;
        }, 2000);
      });
    }, 'image/png');
  }).catch(function() {
    stats.style.display = '';
    btn.textContent = 'Failed';
    setTimeout(function() {
      btn.textContent = 'Copy screenshot';
      btn.disabled = false;
    }, 2000);
  });
}
</script>
{{end}}
